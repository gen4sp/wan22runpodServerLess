# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ torchaudio

## –ü—Ä–æ–±–ª–µ–º–∞

–û—à–∏–±–∫–∞: `AttributeError: partially initialized module 'torchaudio' has no attribute 'lib' (most likely due to a circular import)`

–≠—Ç–∞ –æ—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞:

1. –ö—Ä—É–≥–æ–≤—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –º–µ–∂–¥—É torchaudio –∏ –¥—Ä—É–≥–∏–º–∏ PyTorch –º–æ–¥—É–ª—è–º–∏
2. –ù–µ–ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ mock-–º–æ–¥—É–ª—è torchaudio
3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ mock-–≤–µ—Ä—Å–∏–∏

## –†–µ—à–µ–Ω–∏–µ

### 1. –£–ª—É—á—à–µ–Ω–Ω—ã–π mock-–º–æ–¥—É–ª—å –≤ `sitecustomize.py`

-   –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∞—Ç—Ä–∏–±—É—Ç `lib`
-   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–º–æ–¥—É–ª–µ–π —á–µ—Ä–µ–∑ `ModuleType`
-   –î–æ–±–∞–≤–ª–µ–Ω –∞—Ç—Ä–∏–±—É—Ç `__file__` –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–º–∏—Ç–∞—Ü–∏–∏ –º–æ–¥—É–ª—è

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç—á–∏

–§–∞–π–ª—ã `torchaudio_patch.py` –∏ `remove_torchaudio.py` —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è:

-   `torchaudio.lib` –∫–ª–∞—Å—Å–∞
-   –ü—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞ `__file__`

### 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

-   –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_torchaudio_fix.py`
-   –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ `startup.sh`
-   –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ `Dockerfile` –Ω–∞ —ç—Ç–∞–ø–µ —Å–±–æ—Ä–∫–∏

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–º–æ–¥—É–ª–µ–π
sys.modules['torchaudio.transforms'] = MockTorchAudio.transforms()  # ‚ùå
sys.modules['torchaudio.functional'] = MockTorchAudio.functional()  # ‚ùå

# –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∞—Ç—Ä–∏–±—É—Ç lib
class MockTorchAudio:
    # lib –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–º–æ–¥—É–ª–µ–π
transforms_module = ModuleType('torchaudio.transforms')  # ‚úÖ
functional_module = ModuleType('torchaudio.functional')  # ‚úÖ
lib_module = ModuleType('torchaudio.lib')               # ‚úÖ

# –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å lib
class MockTorchAudio:
    class lib:  # ‚úÖ
        pass
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
python test_torchaudio_fix.py
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
‚úÖ torchaudio –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ: 2.1.0+mock
‚úÖ lib: –Ω–∞–π–¥–µ–Ω
‚úÖ transforms: –Ω–∞–π–¥–µ–Ω
‚úÖ functional: –Ω–∞–π–¥–µ–Ω
‚úÖ backend: –Ω–∞–π–¥–µ–Ω
‚úÖ __version__: –Ω–∞–π–¥–µ–Ω
‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
‚úÖ –í—Å–µ –ø–æ–¥–º–æ–¥—É–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
‚úÖ –ö—Ä—É–≥–æ–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã:

-   `CM_DISABLE_TORCHAUDIO=1`
-   `DISABLE_TORCHAUDIO_CUDA_CHECK=1`
-   `TORCH_AUDIO_BACKEND=soundfile`
-   `TORCHAUDIO_BACKEND=soundfile`

## –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ç—á–µ–π

1. –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ torchaudio
2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `sitecustomize.py` (—Ä–∞–Ω–Ω–∏–π –ø–∞—Ç—á)
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ `torchaudio_patch.py`
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å `test_torchaudio_fix.py`
5. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `startup.sh`
